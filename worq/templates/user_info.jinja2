<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>{{ title or 'User Information' }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
  <link rel="stylesheet" href="{{ request.static_url('worq:static/assets/style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <header>
    <nav class="navbar navbar-expand-lg" style="background-color: #465158;">
      <div class="container-fluid">
        <img src="{{ request.static_url('worq:static/WorkQ.png') }}" alt="Logo" width="50" height="50">
      </div>
    </nav>
  </header>

  <section class="outt">
    <section class="out2">
      <section class="in-name">
        <h1>User information</h1>
      </section>

      <section class="out3">
        <section class="user-info">
          <form id="userForm" method="POST" enctype="multipart/form-data">
              <h5>User information</h5>
              <input class="user-bck" type="text" name="name" value="{{ user_name }}" placeholder="Name" required>
              <input class="user-bck" type="text" name="number" value="{{ user_tel }}" placeholder="Number" required>
              <input class="user-bck" type="file" name="pro_file" placeholder="Choose file for profile picture">
              <input class="buttons" type="submit" value="Submit">
          </form>
        </section>

        <section class="change-password">
          <form id="passForm" method="POST">
              <h5>Change password</h5>
              <input class="user-bck" type="password" name="pass" placeholder="Actual password">
              <input class="user-bck" type="password" name="n_pass" placeholder="New password">
              <input class="user-bck" type="password" name="cn_pass" placeholder="Confirm new password">
              <input class="buttons" type="submit" value="Submit">
          </form>
        </section>
      </section>

      <br>
      <input class="back-btn" type="button" value="Back" onclick="history.back();">
      <br><br><br>
    </section>
    <br><br>
  </section>

  <!-- Modal de Ã©xito -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="successModalLabel">Success</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          The operation was completed successfully!
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de error -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="errorModalLabel">Error</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="errorMessage">
          An error occurred.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script AJAX -->
  <script>
    $(document).ready(function () {
      // EnvÃ­o del formulario de perfil
      $('#userForm').submit(function (event) {
        event.preventDefault();

        const formData = new FormData(this);

        $.ajax({
          url: "{{ request.route_url('info_user') }}",
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            if (response.success) {
              const successModal = new bootstrap.Modal(document.getElementById('successModal'));
              successModal.show();
            } else {
              document.getElementById('errorMessage').textContent = response.error || "An unexpected error occurred.";
              const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
              errorModal.show();
            }
          },
          error: function () {
            document.getElementById('errorMessage').textContent = "Error during submission.";
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
          }
        });
      });

      // EnvÃ­o del formulario de cambio de contraseÃ±a
      $('#passForm').submit(function (event) {
        event.preventDefault();

        const formData = {
          pass: $('input[name="pass"]').val(),
          n_pass: $('input[name="n_pass"]').val(),
          cn_pass: $('input[name="cn_pass"]').val()
        };

        $.ajax({
          url: "{{ request.route_url('info_user') }}",
          type: "PUT",
          data: $.param(formData),
          contentType: "application/x-www-form-urlencoded",
          success: function (response) {
            if (response.success) {
              const successModal = new bootstrap.Modal(document.getElementById('successModal'));
              successModal.show();

              // ðŸš¿ Limpiar los inputs del formulario
              $('#passForm')[0].reset();
            } else {
              document.getElementById('errorMessage').textContent = response.error || "An unexpected error occurred.";
              const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
              errorModal.show();
            }
          },
          error: function () {
            document.getElementById('errorMessage').textContent = "Error during password change.";
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
          }
        });
      });
    });
  </script>
</body>
</html>