{% extends "workq_main.jinja2" %}

{% block content %}
<div class="container">
  <div class="form-box2">
    <div class="form-box">
      <div class="form-header">
        <h2 class="form-title">Create Project</h2>
        <form id="create-project-form" method="POST" action="{{ request.route_url('pm_main') }}">
          <div class="form-inner">
            <input class="controls" type="text" id="name" name="name" placeholder="Name" required>

            <div class="add-group">
                    <label for="startdate">Start Date</label>
                    <input type="date" id="startdate" name="startdate" min="{{ now }}">
              </div>


              <div class="add-group">
                    <label for="enddate">End Date</label>
                    <input type="date" id="enddate" name="enddate" min="{{ now }}">
                </div>

            <div class="icon-preview full-width">
              <button class="buttons" type="submit" id="submit-button">Create</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
document.getElementById('create-project-form').addEventListener('submit', function(event) {
  event.preventDefault();
  const form = this;
  const formData = new FormData(form);

  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'Accept': 'application/json' // <-- Esto es clave para que el backend responda JSON
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const successModal = new bootstrap.Modal(document.getElementById('successModal'));
      successModal.show();
      document.getElementById('successModal').addEventListener('hidden.bs.modal', function() {
        window.location.reload();
      });
    } else {
      document.getElementById('errorMessage').textContent = data.error || 'The project could not be created.';
      const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
      errorModal.show();
    }
  })
  .catch(error => {
    document.getElementById('errorMessage').textContent = 'An unexpected error occurred.';
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    errorModal.show();
  });
});

</script>
<!-- Modal de Ã©xito -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Success</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        The project has been created successfully!
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de error -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="errorMessage">
        The project could not be created.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

